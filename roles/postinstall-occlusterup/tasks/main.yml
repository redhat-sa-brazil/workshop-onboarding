- name:  Instala pacotes necessários
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - git
    - docker-1.13.1
    - p7zip
    - python-rhsm-certificates
    - httpd-tools

- name: "adicionando insecure registry"
  lineinfile:
    path: /etc/sysconfig/docker
    regexp: "^OPTIONS"
    line: "OPTIONS='--insecure-registry=172.30.0.0/16 --selinux-enabled --log-opt max-size=1M --log-opt max-file=3'"

- name: Inicia docker
  service:
    name: docker
    state: started
    enabled: yes

# - name: Baixa imagens docker (async)
#   shell: docker pull registry.access.redhat.com/openshift3/ose-haproxy-router:v3.7.42 && docker pull registry.access.redhat.com/openshift3/ose-deployer:v3.7.42 && docker pull registry.access.redhat.com/openshift3/ose-sti-builder:v3.7.42 && docker pull registry.access.redhat.com/openshift3/ose:v3.7.42 && docker pull registry.access.redhat.com/openshift3/ose-docker-registry:v3.7.42 && docker pull registry.access.redhat.com/openshift3/ose-pod:v3.7.42 && docker pull registry.access.redhat.com/rhscl/php-71-rhel7 && docker pull registry.access.redhat.com/rhscl/mysql-57-rhel7
#   async: 1000
#   poll: 0
#   register: docker_status

- name: Clona git onboarding app
  git:
    repo: 'https://github.com/redhat-sa-brazil/workshop-onboarding'
    dest: /tmp/onboarding-app
    accept_hostkey: yes
    force: yes
  become: yes

- name: Descompacta oc e salve na pasta bin
  shell: "rm -rf /usr/local/bin/oc ; cd /tmp/onboarding-app/roles/postinstall-occlusterup/files && 7za e oc.7z && mv /tmp/onboarding-app/roles/postinstall-occlusterup/files/oc /usr/local/bin"
  become: yes

- name: Clona git oc-cluster-wrapper
  git:
    repo: 'https://github.com/openshift-evangelists/oc-cluster-wrapper.git'
    dest: /usr/local/oc-cluster-wrapper
    accept_hostkey: yes
    force: yes
  become: yes

- name: Atualizar variavel bash_profile
  shell: "echo 'PATH=/usr/local/oc-cluster-wrapper:$PATH' >> $HOME/.bash_profile"
  become: yes

- name: Salva OC ClusterUP ip no profile
  shell: "echo 'export OC_CLUSTER_PUBLIC_HOSTNAME={{ inventory_hostname }}' >> $HOME/.bash_profile"
  become: yes

# - name: 'Docker - check on async task'
#   async_status:
#     jid: "{{ docker_status.ansible_job_id }}"
#   register: job_result
#   until: job_result.finished
#   retries: 120

- name: Sobe OC ClusterUP
  shell: "export PATH=$PATH:/usr/local/bin; /usr/local/oc-cluster-wrapper/oc-cluster up workshop --public-hostname='{{ inventory_hostname }}' --version=v3.7.42"
  become: yes

#- name: Criar arquivo de senhas
#  shell: htpasswd -b -c /root/.oc/profiles/workshop/config/master/users.htpasswd admin redhat@123
#  become: yes

#- name: Altera auth para Local
#  lineinfile:
#    path: /root/.oc/profiles/workshop/config/master/master-config.yaml
#    regexp: 'anypassword'
#    line: '    name: Local'
#    backup: yes
#  become: yes

#- name: Altera login para htpasswd
#  lineinfile:
#    path: /root/.oc/profiles/workshop/config/master/master-config.yaml
#    regexp: 'AllowAllPasswordIdentityProvider'
#    line: '      kind: HTPasswdPasswordIdentityProvider'
#    backup: yes
#  become: yes

#- name: Configura arquivo htpasswd
#  lineinfile:
#    path: /root/.oc/profiles/workshop/config/master/master-config.yaml
#    insertafter: 'HTPasswdPasswordIdentityProvider'
#    line: '      file: /root/.oc/profiles/workshop/config/master/users.htpasswd'
#    backup: yes
#  become: yes

- name: Espera por OC Cluster UP no ar...
  shell: "/usr/local/bin/oc login -u admin -p qualquersenha https://localhost:8443 --insecure-skip-tls-verify=true | grep successful"
  register: result
  until: result.stdout.find("Login successful.") != -1
  retries: 10
  delay: 10
  become: yes

- name: Aumenta quantidade de pods no cluster
  blockinfile:
    path: /root/.oc/profiles/workshop/config/node-localhost/node-config.yaml
    insertafter: "kubeletArguments"
    backup: yes
    content: |2
        pods-per-core:
          - "50"
        max-pods:
          - "100"
  become: yes

- name: Login no cluster
  shell: "/usr/local/bin/oc login -u admin -p qualquersenha"
  become: yes

#- name: Cria SA para geracao de token
#  shell: "/usr/local/bin/oc create serviceaccount monitoring -n openshift-infra"
#  become: yes

#- name: Da permissao de cluster-admin para usuario do token
#  shell: "/usr/local/bin/oc adm policy add-cluster-role-to-user cluster-admin monitoring -z monitoring"
#  become: yes

#- name: Obtem nome do token
#  shell: "/usr/local/bin/oc describe sa monitoring -n openshift-infra | grep Tokens | awk {'print $2'}"
#  become: yes
#  register: nome_token

#- name: Obtem Token
#  shell: "/usr/local/bin/oc describe secret {{ nome_token.stdout }} -n openshift-infra | grep token: | awk {'print $2'}"
#  become: yes
#  register: token

- name: Obtem Token
  shell: "/usr/local/bin/oc whoami --show-token=true"
  become: yes
  register: token

- name: Importa template do xpaas
  shell: "/usr/local/bin/oc create -f {{item}} -n openshift"
  with_items:
    - https://raw.githubusercontent.com/openshift/openshift-ansible/master/roles/openshift_examples/files/examples/v3.9/xpaas-streams/fis-image-streams.json
    - https://raw.githubusercontent.com/openshift/openshift-ansible/master/roles/openshift_examples/files/examples/v3.9/xpaas-streams/jboss-image-streams.json
    - https://raw.githubusercontent.com/openshift/openshift-ansible/master/roles/openshift_examples/files/examples/v3.9/xpaas-templates/datagrid71-basic.json
  become: yes

- name: Cria projeto workshop-apoio
  shell: "/usr/local/bin/oc adm new-project workshop-apoio --admin=admin || echo 'já existe'"
  become: yes

- name: Da permissoes de anyuid para workshop-apoio
  shell: "/usr/local/bin/oc adm policy add-scc-to-user anyuid -z default -n workshop-apoio"
  become: yes

- name: Instala banco de dados para Etherpad
  shell: "/usr/local/bin/oc new-app mysql-persistent --param MYSQL_USER=ether --param MYSQL_PASSWORD=ether --param MYSQL_DATABASE=ether --param VOLUME_CAPACITY=1Gi --param MYSQL_VERSION=5.7 --param MEMORY_LIMIT=256Mi --param DATABASE_SERVICE_NAME=mysql-ether -n workshop-apoio"
  become: yes

- name: Instala Etherpad
  shell: "/usr/local/bin/oc new-app -f https://raw.githubusercontent.com/luszczynski/docker-openshift-etherpad/master/etherpad-template.yaml -p DB_USER=ether -p DB_PASS=ether -p DB_DBID=ether -p DB_PORT=3306 -p DB_HOST=mysql-ether -p ADMIN_PASSWORD=secret -n workshop-apoio"
  become: yes

- name: Cria Wetty Terminal (Backup)
  shell: "/usr/local/bin/oc new-app lasher/wetty-single --name=wetty -n workshop-apoio || echo 'já existe'"
  become: yes

- name: Scale down wetty
  shell: "/usr/local/bin/oc scale dc wetty --replicas=0 -n workshop-apoio"
  become: yes

- name: Cria rota para acesso ao wetty
  shell: "/usr/local/bin/oc expose svc/wetty -n workshop-apoio || echo 'já existe'"
  become: yes

- name: Obtem nome da rota
  shell: "/usr/local/bin/oc get route wetty --no-headers -n workshop-apoio | awk '{print $2}'"
  become: yes
  register: result_dominio_wetty

- name: Cria diretorio workshop-stuff
  file: 
   path: /workshop-stuff
   state: directory
   mode: 0775

- name: Copia json para Instancia
  copy:
   src: "{{ credentials_file }}"
   dest: "/workshop-stuff/conteudo_json_gce.json"

- name: Copia chave ssh para Instancia
  copy:
   src: "{{ ansible_ssh_private_key_file }}"
   dest: "/workshop-stuff/chave_ssh"

- name: Cria config map para Instructor
  shell: "/usr/local/bin/oc create configmap instructor-stuff --from-file=/workshop-stuff -n workshop-apoio"

- name: Salva url etherpad
  shell: "/usr/local/bin/oc get route etherpad --no-headers -n workshop-apoio | awk '{print $2}'"
  register: result_dominio_etherpad
  become: yes

- name: Cria deployment Web Instructor
  shell: "/usr/local/bin/oc new-app  URL_WETTY=http://{{ result_dominio_wetty.stdout }} CLUSTER_OPENSHIFT=https://{{ inventory_hostname }}:8443 TOKEN_OPENSHIFT={{ token.stdout }} https://github.com/redhat-sa-brazil/workshop-onboarding-apps ETHERPAD_URL={{result_dominio_etherpad.stdout}} --context-dir=Workshop-PHP-Instructor --name=web-instructor --strategy=docker -n workshop-apoio || echo 'já existe'"
  become: yes

- name: "Anexa o volume de config map"
  shell: "/usr/local/bin/oc volumes dc/web-instructor --add --mount-path=/etc/ansible/workshop-stuff --configmap-name=instructor-stuff --type=configmap -n workshop-apoio"

- name: Cria rota para acesso ao web-workshop
  shell: "/usr/local/bin/oc expose svc/web-instructor -n workshop-apoio || echo 'já existe'"
  become: yes

- name: Obtem nome da rota
  shell: "/usr/local/bin/oc get route web-instructor --no-headers -n workshop-apoio | awk '{print $2}'"
  become: yes
  register: result_dominio_web_workshop

- name: Criar banco de dados
  shell: "/usr/local/bin/oc new-app --template=mysql-persistent --param=MYSQL_USER=admin --param=MYSQL_DATABASE=workshop --param=MYSQL_PASSWORD=redhat@123 --param=MYSQL_ROOT_PASSWORD=redhat@123 --param=VOLUME_CAPACITY=5Gi -n workshop-apoio || echo 'já existe'"
  become: yes

- name: Cria projeto workshop-alunos
  shell: "/usr/local/bin/oc adm new-project workshop-alunos --admin=admin || echo 'já existe'"
  become: yes

- name: Da permissoes de anyuid para workshop-apoio
  shell: "/usr/local/bin/oc adm policy add-scc-to-user anyuid -z default -n workshop-alunos"
  become: yes

- name: Cria aplicação do sorteio
  shell: "/usr/local/bin/oc new-app https://github.com/redhat-sa-brazil/workshop-onboarding-app-sorteio --image-stream=fis-java-openshift:2.0 --name=sorteio -n workshop-apoio"
  become: yes

- name: Cria rota para acesso ao sorteio
  shell: "/usr/local/bin/oc expose svc/sorteio -n workshop-apoio || echo 'já existe'"
  become: yes

- name: Pause dc triggers
  shell: "/usr/local/bin/oc rollout pause dc sorteio -n workshop-apoio"
  become: yes

- name: Altera limite de cpu e memoria
  shell: "/usr/local/bin/oc set resources dc sorteio --limits=cpu=400m,memory=350Mi -n workshop-apoio"
  become: yes

- name: Resume dc triggers
  shell: "/usr/local/bin/oc rollout resume dc sorteio -n workshop-apoio"
  become: yes

- name: Imprimindo mensagem de sucesso
  debug:
   msg: "O link de acesso para seu ambiente do Openshift é: https://{{ inventory_hostname }}:8443 \nSeu ambiente de Workshop esta disponivel em {{ result_dominio_web_workshop.stdout }}"
